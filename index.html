<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Selection Start Point</title>
</head>
<body>
    <button onclick="exec('1', 'bold')">Bold</button>
    <button onclick="exec('1', 'italic')">Italic</button>
    <!-- <div id="1" contenteditable="true"><i><b>A</b></i>&gt;AHoj&lt;<b>Ahoj</b></div> -->
    <div id="1" contenteditable="true">Hello <b>World</b> there</div>
    <!-- <div id="1" contenteditable="true"><b>a</b>bcdefg</div> -->
</body>
<script>
    function tagName(action) {
        switch (action) {
            case "bold": return "b";
            case "italic": return "i";
            default: return null;
        }
    }

    function lastIn(text) {
        let inTag = false;
        for (let index = 0; index < text.length; index++) {
            if (!inTag && text[index] != "<") {
                return false;
            } else if (!inTag && text[index] == "<") {
                inTag = true;
            } else if (inTag && text[index] == ">") {
                inTag = false;
            }
        }
        return true;
    }

    function lastOccuranceIn(haystack, needle) {
        let lastOccurance = haystack.lastIndexOf(needle);
        if (lastOccurance == -1) { return false; }
        haystack = haystack.substring(lastOccurance + needle.length);
        return lastIn(haystack);
    }

    function firstOccuranceIn(haystack, needle) {
        let firstOccurance = haystack.indexOf(needle);
        if (firstOccurance == -1) { return false; }
        haystack = haystack.substring(0, firstOccurance + needle.length);
        return lastIn(haystack);
    }

    function removeFromEnd(haystack, needle) {
        let lastOccurance = haystack.lastIndexOf(needle);
        return haystack.substring(0, lastOccurance) + haystack.substring(lastOccurance).replace(needle, "");
        // return haystack.substring(0, haystack.length - needle.length);
    }
    
    function removeFromStart(haystack, needle) {
        return haystack.replace(needle, "");
        // return haystack.substring(needle.length);
    }

    function exec(id, action) {
        let node = document.getElementById(id);
        let content = node.innerHTML;

        let start = actualIndex(id, getSelectionIndex(0), true);
        let end = actualIndex(id, getSelectionIndex(1), false);

        console.log(`${start} - ${end}`);
        if (start < end && start >= 0 && end >= 0) {
            let before = content.substring(0, start);
            let selection = content.substring(start, end);
            let after = content.substring(end);

            console.log(`${before}\n${selection}\n${after}`);
            if (tagName(action) == null) { return; }
            let openingTag = `<${tagName(action)}>`, enclosingTag = `</${tagName(action)}>`;

            /* If selection is on the whole selection of some fomatting */
            if (firstOccuranceIn(selection, openingTag) && lastOccuranceIn(selection, enclosingTag)) { // ... | <x>...</x> | ...
                selection = removeFromStart(selection, openingTag);
                selection = removeFromEnd(selection, enclosingTag);
            } else if (lastOccuranceIn(before, openingTag) && firstOccuranceIn(after, enclosingTag)) { // ...<x> | ... | </x>... 
                before = removeFromEnd(before, openingTag);
                after = removeFromStart(after, enclosingTag);
            } else if (lastOccuranceIn(before, openingTag) && lastOccuranceIn(selection, enclosingTag)) { // ...<x> | ...</x> | ...
                before = removeFromEnd(before, openingTag);
                selection = removeFromEnd(selection, enclosingTag);
            } else if (firstOccuranceIn(selection, openingTag) && firstOccuranceIn(after, enclosingTag)) { // ... | <x>... | </x>...
                selection = removeFromStart(selection, openingTag);
                after = removeFromStart(after, enclosingTag);
            } else { /* If selection is NOT on the whole selection of some fomatting */
                let startTags = tagsIn(0, start, [], id);
                if (startTags == -1) { return; }
                let endTags = tagsIn(start, end, startTags.slice(0), id);
                if (endTags == -1) { return; }
                let fullTags = tagsIn(start, end, startTags.slice(0), id, true);

                if (!startTags.includes(tagName(action)) && !firstOccuranceIn(selection, openingTag) && !endTags.includes(tagName(action)) && !lastOccuranceIn(selection, enclosingTag)) {
                    selection = selection.replace(openingTag, '');
                    selection = selection.replace(enclosingTag, '');
                    selection = openingTag + selection + enclosingTag;
                    console.log("1");
                } else if (false) {

                } else if (startTags.includes(tagName(action)) && endTags.includes(tagName(action)) && !fullTags.includes(tagName(action))) {
                    console.log("2");
                } else if (firstOccuranceIn(selection, openingTag) && fullTags.includes(tagName(action))) {
                    selection = removeFromStart(selection, openingTag) + openingTag;
                } else if ((lastOccuranceIn(selection, enclosingTag) || firstOccuranceIn(after, enclosingTag)) && fullTags.includes(tagName(action))) {
                    selection = enclosingTag + removeFromEnd(selection, enclosingTag);
                    console.log("3");
                } else if (false) {
                    console.log("4");
                    // replace last ???
                } else if (fullTags.includes(tagName(action))) {
                    // selection = enclosingTag + selection + openingTag
                    // console.log("5");
                }
            }

            node.innerHTML = processContent(before + selection + after);
            console.log(node.innerHTML);
        }
    }

    function processContent(content) {
        let inTag = false, currentTagName = "", isFollowing = false;

        for (let i = 0; i < content.length; i++) {

        }
        return content;
    }

    function stripHtml(html)
    {
        let tmp = document.createElement("DIV");
        tmp.innerHTML = html;
        return tmp.textContent || tmp.innerText || "";
    }

    function tagsIn(from, to, currentTags, id, onlyFull = false) { // Returns formating of text on some index
        let content = document.getElementById(id).innerHTML;
        let inTag = false, currentTagName = "", allTags = currentTags.slice(0);

        for (let index = from; index < to; index++) {
            if (!inTag && content[index] == "<") {
                inTag = true;
            } else if (inTag && content[index] == ">" && currentTagName.startsWith("/")) {
                if (currentTags.includes(currentTagName.substring(1))) {
                    currentTags.splice(currentTags.indexOf(currentTagName.substring(1)), 1);
                    currentTagName = "";
                    inTag = false;
                } else {
                    return -1;
                }
            } else if (inTag && content[index] != ">") {
                currentTagName += content[index];
            } else if (inTag && content[index] == ">") {
                if (onlyFull && !allTags.includes(currentTagName) || !onlyFull) {
                    currentTags.push(currentTagName);
                    allTags.push(currentTagName);
                }
                inTag = false;
                currentTagName = "";
            }
        }

        return currentTags;
        // return allTags;
    }

    function actualIndex(id, breakIndex, isStart) {
        let content = document.getElementById(id).innerHTML;
        let inTag = false, inEscape = false;
        let actualIndex = -1;

        for (let index = 0; index <= breakIndex; actualIndex++) {
            if (!inEscape && !inTag) {
                if (content[actualIndex] == "<") {
                    inTag = true;
                } else if (content[actualIndex] == "&") {
                    inEscape = true;
                } else {
                    index++;
                }
            } else if (inEscape && content[actualIndex] == ";") {
                inEscape = false;
                index++;
            } else if (inTag && content[actualIndex] == ">") {
                inTag = false;
            }
        }

        while (content[actualIndex] == "<" && content[actualIndex + 1] != "/" && !isStart) {
            while (true) {
                if (content[actualIndex++] == ">") {
                    break;
                }
            }
        }

        return actualIndex;
    }

    function getSelectionIndex(type) {
        let selection = window.getSelection();
        let offset; let node;
        
        if (selection.rangeCount > 0) {
            if (type === 0) {
                offset = selection.getRangeAt(0).startOffset;
                node = selection.getRangeAt(0).startContainer;
            } else if (type === 1) {
                offset = selection.getRangeAt(0).endOffset;
                node = selection.getRangeAt(0).endContainer;
            } else {
                return -1;
            }

            while (node.tagName !== "DIV") {
                if (node.previousSibling) {
                    node = node.previousSibling;
                    if (node.textContent) {
                        offset += node.textContent.length;
                    } else {
                        return -1;
                    }
                } else {
                    node = node.parentNode;
                }            
            }

            return offset;
        }
    }
</script>
</html>
